# Stage that saves the current repository's information into AWS DynamoDB.
# The saved information is to be used in other applications that will display
# a list of repositories and their basic information.
# The information being saved is the slug, title, url, latest version, and link to the icon

.save-repo-info:
  stage: release
  image:
    name: public.ecr.aws/b9b5m9f7/base-images:cicd-toolkit_0.1
    entrypoint: [""]
  rules:
    - if: $CI_MERGE_REQUEST_ID
      when: never
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_COMMIT_BRANCH == "main"
      when: on_success
    - when: never
  variables:
    AWS_REPO_TABLE_NAME: git-repos
    ICON_URL: "${CI_PROJECT_URL}/raw/main/repo-icon.png"
  before_script:
    - aws configure set aws_access_key_id ${AWS_ACCESS_KEY_ID}
    - aws configure set aws_secret_access_key ${AWS_SECRET_ACCESS_KEY}
    - aws configure set region ${AWS_DEFAULT_REGION}
    - aws configure set output json
  script:
    - |
      aws dynamodb put-item \
      --table-name ${AWS_REPO_TABLE_NAME} \
      --item '{"slug": {"S": "\"$CI_PROJECT_NAME\""}, "title": {"S": "$CI_PROJECT_TITLE"}, "url": {"S": "$CI_PROJECT_URL"}, "version": {"S": "$VERSION"}, "icon": {"S": "$ICON_URL"}}'